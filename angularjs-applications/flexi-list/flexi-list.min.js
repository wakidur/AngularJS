/*! flexy-list 2015-08-30 */
"use strict";var flexiList=angular.module("flexiList",[]);flexiList.factory("flexiListService",["$q","$http","$log","$filter",function(a,b,c,d){return{requestJsonFile:function(c){var d=a.defer();return b({method:"GET",url:c}).success(function(a,b){d.resolve(a)}).error(function(a,b){d.reject("ERROR: "+b)}),d.promise},requestServer:function(d,e){var f=a.defer(),g={};if(d.limit&&(g.limit=d.limit),d.searchable&&!d.searchOnClient&&(g.where=d.where),d.sortable&&!d.sortOnClient&&(g.orderby=d.orderby),d.pagination&&!d.paginationOnClient&&(g.offset=e,g.pagesize=d.pagesize),d.urlencoded)if("GET"==d.method){var h=d.listURL+"?"+jQuery.param(g);d.log.debug&&c.log(d.log.id+" URL: "+h),b({method:"GET",url:h}).success(function(a,b){f.resolve(a)}).error(function(a,b){f.reject("ERROR: "+b)})}else b({method:"POST",url:d.listURL,data:jQuery.param(g),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,b){f.resolve(a)}).error(function(a,b){f.reject("ERROR: "+b)});else"GET"==d.method?b({method:"GET",url:d.listURL,params:g}).success(function(a,b){f.resolve(a)}).error(function(a,b){f.reject("ERROR: "+b)}):b.post(d.listURL,g).success(function(a,b){f.resolve(a)}).error(function(a,b){f.reject("ERROR: "+b)});return f.promise},sortDataset:function(a,b,c){var e=[];if(b[0]){var f="desc"==b[0].type;e=d("orderBy")(a,b[0].field,f)}else e=a;return e},filterDataset:function(a,b,e){var f,g,h,i,j,k,l=[];if(b.length)for(var m=0;m<a.length;m++){k=!0;for(var n=0;n<b.length;n++)if(f=b[n].field,g=a[m][f],h=b[n].condition,i=b[n].value,j=b[n].options,f&&h){try{k=d(h)(g,i,j)}catch(o){e.err&&c.log(e.id+" - flexiListService: filter exception at ",o),k=!0}if(e.debug&&c.log(e.id+" - filterDataset: value="+g+" condition="+h+" pattern="+i+" passed="+k),!k)break}k&&l.push(a[m])}else l=a;return l},processDataset:function(a,b,c,e,f){var g=this.filterDataset(a,b,f),h=this.sortDataset(g,c,f),i=d("limitTo")(h,e);return i},pageDataset:function(a,b,c,d){var e=[],f=b+c;f>a.length&&(f=a.length);for(var g=b;f>g;g++)e.push(a[g]);return e},getPagination:function(a,b,c,d){var e={},f=b/c+1,g=Math.ceil(a/c),h=f-2;1>h&&(h=1);var i=h+d-1,j=i-g;j>0&&(i=g,h-=j,1>h&&(h=1));var k=(f-1)*c+1,l=f*c;l>a&&(l=a);for(var m=[],n=h;i>=n;n++)m.push(n);return e.firstrec=k,e.lastrec=l,e.rowcount=a,e.currpage=f,e.lastpage=i,e.pages=m,e.totalpages=g,e.show_pages=d,e.pagesize=c,e}}}]),flexiList.controller("flMainCtrl",["$scope","$log","$q","$http","$filter","flexiListService",function(a,b,c,d,e,f){function g(){return a.list?(angular.extend(w,a.list.options),a.list.loadData=function(a,b){angular.extend(w,a),b&&(y=0),v()},a.list.change=function(a){u(a)},a.list.refresh=function(){v()},a.list.selectEnabled=function(){return w.selectable},a.list.multiselectEnabled=function(){return w.selectable&&w.multiselect},a.list.paginationEnabled=function(){return w.pagination&&a.list.records.length>0?!0:!1},a.list.sortEnabled=function(){return w.sortable},a.list.searchEnabled=function(){return w.searchable},a.list.isEmpty=function(){return 0==a.list.records.length&&a.list.loadedDS},w.sortable&&h(),w.pagination&&o(),w.selectable&&k(),void(w.autoload&&v())):void(w.log.err&&b.log(w.log.id+" - undefined scope."))}function h(){a.list.isSortedAsc=function(a){return z?"asc"==z[a]:!1},a.list.isSortedDesc=function(a){return z?"desc"==z[a]:!1}}function i(a){w.orderby=a,z=j()}function j(){var a=[];if(w.orderby)for(var b=0;b<w.orderby.length;b++)a[w.orderby[b].field]=w.orderby[b].type;return a}function k(){a.list.isRecordSelected=function(a){return a.flSelected?!0:!1},a.list.recordToggleSelect=function(a){a.flSelected?n(a,!1):m(a,!1)},a.list.enforceSelection=function(a){a.flSelected?m(a,!0):n(a,!0)},a.list.getToggleSelNextState=function(){return C},w.multiselect&&(a.list.toggleSelectAll=function(){a.list.records&&(C=!C,l(C,!0))}),a.list.getSelectedCount=function(){return B},a.list.getSelectedRecords=function(){var b=[];return a.list.records&&angular.forEach(a.list.records,function(a){a.flSelected&&b.push(a)}),b}}function l(b,c){c?angular.forEach(a.list.records,function(a){b?m(a,!1):n(a,!1)}):angular.forEach(a.list.client_ds,function(a){b?m(a,!1):n(a,!1)}),C=b}function m(a,b){a.readonly||(b||!a.flSelected)&&(w.multiselect?(a.flSelected=!0,B++):(A&&(A.flSelected=!1),a.flSelected=!0,A=a,B=1))}function n(a,b){a.readonly||(b||a.flSelected)&&(w.multiselect?(a.flSelected=!1,B--):(A=!1,a.flSelected=!1,B=0))}function o(){a.list.changePage=function(a){p(a)},a.list.setPageSize=function(a){w.pagesize=a,p(1)}}function p(b){1>b||b>a.list.pagination_info.totalpages||(a.$emit("flStartOp",{op:"getPage"}),w.selectable&&w.pagination_clear_selection&&l(!1,!1),y=(b-1)*w.pagesize,w.paginationOnClient?(a.list.records=f.pageDataset(a.list.client_ds,y,w.pagesize,w.log),a.list.pagination_info=f.getPagination(x,y,w.pagesize,w.pages),a.$emit("flComplete",{result:"OK"})):v())}function q(){w.paginationOnClient=!0,w.sortOnClient=!0,w.searchOnClient=!0,a.list.loadedDS=w.data,a.list.loadedDS||(a.list.loadedDS=[],w.log.err&&b.log(w.log.id+" - Load Error.")),a.list.client_ds=f.processDataset(w.data,w.where,w.orderby,w.limit,w.log),x=a.list.client_ds.length,w.pagination?(a.list.records=f.pageDataset(a.list.client_ds,y,w.pagesize,w.log),a.list.pagination_info=f.getPagination(x,y,w.pagesize,w.pages)):a.list.records=a.list.client_ds,z=j()}function r(){a.list.client_ds=f.processDataset(a.list.loadedDS,w.where,w.orderby,w.limit,w.log),x=a.list.client_ds.length,w.pagination?(a.list.records=f.pageDataset(a.list.client_ds,y,w.pagesize,w.log),a.list.pagination_info=f.getPagination(x,y,w.pagesize,w.pages)):a.list.records=a.list.client_ds}function s(){w.paginationOnClient=!0,w.sortOnClient=!0,w.searchOnClient=!0;var c=f.requestJsonFile(w.jsonFile);c.then(function(c){w.log.debug&&b.log(w.log.id+" - Data: "+e("json")(c)),c||(c=[]),a.list.loadedDS=c,r(),z=j(),a.$emit("flComplete",{result:"OK"})},function(c){w.log.err&&b.log(w.log.id+" - Load Error: "+c),a.list.loadedDS=[],a.list.records=[],a.$emit("flComplete",{result:"ERROR",message:c})})}function t(){var c=f.requestServer(w,y);c.then(function(c){if(a.list.server_response=c,w.log.debug&&b.log(w.log.id+" - Data: "+e("json")(c)),c?"OK"!=c.result&&w.log.err&&b.log(w.log.id+" - data.result: "+c.result):c={},c.records||(c.records=[]),a.list.loadedDS=c.records,c.where&&(w.where=c.where),c.orderby?i(c.orderby):z=j(),x=c.rowcount?c.rowcount:c.records.length,a.list.client_ds=c.records,w.searchable&&w.searchOnClient&&(a.list.client_ds=f.filterDataset(a.list.client_ds,w.where,w.log),x=a.list.client_ds.length),w.sortable&&w.sortOnClient&&(a.list.client_ds=f.sortDataset(a.list.client_ds,w.orderby,w.log)),w.pagination)if(w.paginationOnClient)a.list.records=f.pageDataset(a.list.client_ds,y,w.pagesize,w.log),a.list.pagination_info=f.getPagination(x,y,w.pagesize,w.pages);else{a.list.records=c.records;var d;d=c.offset?c.offset:y,c.pagesize&&(w.pagesize=c.pagesize),a.list.pagination_info=f.getPagination(x,d,w.pagesize,w.pages)}else a.list.records=a.list.client_ds;"OK"!=c.result?a.$emit("flComplete",{result:"ERROR",message:c.result}):a.$emit("flComplete",{result:"OK"})},function(c){w.log.err&&b.log(w.log.id+" - Load Error: "+c),a.list.loadedDS=[],a.list.records=[],a.$emit("flComplete",{result:"ERROR",message:c})})}function u(b){a.$emit("flStartOp",{op:"change"}),angular.extend(w,b),w.selectable&&l(!1,!1),y=0,r(),z=j(),a.$emit("flComplete",{result:"OK"})}function v(){a.$emit("flStartOp",{op:"loadData"}),B=0,w.data?(q(),a.$emit("flComplete",{result:"OK"})):w.jsonFile?s():w.listURL?t():(w.log.err&&b.log(w.log.id+" - Undefined data source."),a.$emit("flComplete",{result:"ERROR",message:"Undefined data source"}))}var w={data:!1,jsonFile:!1,listURL:!1,autoload:!0,selectable:!0,multiselect:!0,limit:!1,searchable:!0,searchOnClient:!1,where:[],sortable:!0,sortOnClient:!1,orderby:[],pagination:!0,paginationOnClient:!1,pagination_clear_selection:!0,pagesize:10,pages:5,method:"GET",urlencoded:!0,log:{id:"FL",err:!1,debug:!1}};a.list.loadedDS=!1,a.list.client_ds;var x;a.list.records=[];var y=0;a.list.pagination_info={},g();var z=[],A=!1,B=0,C=!1}]),flexiList.directive("flMain",function(){return{restrict:"E",scope:{list:"="},controller:"flMainCtrl"}}),flexiList.filter("eq",function(){return function(a,b,c){return void 0==a||void 0==b?!0:c&&c.insensitive?a.toLowerCase()==b.toLowerCase():a==b}}),flexiList.filter("ne",function(){return function(a,b){return void 0==a||void 0==b?!0:a!=b}}),flexiList.filter("gt",function(){return function(a,b){return void 0==a||void 0==b?!0:a>b}}),flexiList.filter("ge",function(){return function(a,b){return void 0==a||void 0==b?!0:a>=b}}),flexiList.filter("lt",function(){return function(a,b){return void 0==a||void 0==b?!0:b>a}}),flexiList.filter("le",function(){return function(a,b){return void 0==a||void 0==b?!0:b>=a}}),flexiList.filter("like_l",function(){return function(a,b,c){return void 0==a||void 0==b?!0:c.insensitive?-1!==a.toLowerCase().indexOf(b.toLowerCase(),a.length-b.length):-1!==a.indexOf(b,a.length-b.length)}}),flexiList.filter("like_r",function(){return function(a,b,c){return void 0==a||void 0==b?!0:c.insensitive?0===a.toLowerCase().indexOf(b.toLowerCase()):0===a.indexOf(b)}}),flexiList.filter("like_b",function(){return function(a,b,c){return void 0==a||void 0==b?!0:c.insensitive?-1!==a.toLowerCase().indexOf(b.toLowerCase()):-1!==a.indexOf(b)}}),flexiList.filter("is_null",function(){return function(a,b){return void 0==a?!0:0==a.toString().length}}),flexiList.filter("is_not_null",function(){return function(a,b){return void 0==a?!1:a.toString().length>0}}),flexiList.filter("regexp",function(){return function(a,b,c){if(void 0==a||void 0==b)return!0;var d=new RegExp(b,c.modifier);return d.test(a)}});